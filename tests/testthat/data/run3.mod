$PROBLEM   
$INPUT      ID ITEM DV MDV
$DATA       trial_db_data.csv IGNORE=@
$PRED  

;-----------------------------Hidden variable model------------------------------

PSI=ETA(1)

;----------------------------Item parameter selection----------------------------

;Constants to select the model type
GR=1
PL3=2

MODEL=0 
 
IF(ITEM.EQ.1) THEN
	MODEL=GR
	DIS=THETA(1)		;I1DISGR
	DIF1=THETA(2)		;I1DIF1GR
	DIF2=THETA(3)		;I1DIF2GR
	DIF3=THETA(4)		;I1DIF3GR
	DIF4=THETA(5)		;I1DIF4GR
	DIF5=THETA(6)		;I1DIF5GR
ENDIF
		
 
IF(ITEM.EQ.2) THEN
	MODEL=GR
	DIS=THETA(7)		;I2DISGR
	DIF1=THETA(8)		;I2DIF1GR
	DIF2=THETA(9)		;I2DIF2GR
	DIF3=THETA(10)		;I2DIF3GR
	DIF4=THETA(11)		;I2DIF4GR
	DIF5=THETA(12)		;I2DIF5GR
ENDIF
		
 
IF(ITEM.EQ.3) THEN
	MODEL=PL3
	DIS=THETA(13)		;I3DISPL3
	DIF=THETA(14)		;I3DIFPL3
	GUE=THETA(15)		;I3GUEPL3
ENDIF
		 
IF(ITEM.EQ.4) THEN
	MODEL=PL3
	DIS=THETA(16)		;I4DISPL3
	DIF=THETA(17)		;I4DIFPL3
	GUE=THETA(18)		;I4GUEPL3
ENDIF
		 
IF(ITEM.EQ.5) THEN
	MODEL=PL3
	DIS=THETA(19)		;I5DISPL3
	DIF=THETA(20)		;I5DIFPL3
	GUE=THETA(21)		;I5GUEPL3
ENDIF
		 
IF(ITEM.EQ.6) THEN
	MODEL=PL3
	DIS=THETA(22)		;I6DISPL3
	DIF=THETA(23)		;I6DIFPL3
	GUE=THETA(24)		;I6GUEPL3
ENDIF
		 
IF(ITEM.EQ.7) THEN
	MODEL=PL3
	DIS=THETA(25)		;I7DISPL3
	DIF=THETA(26)		;I7DIFPL3
	GUE=THETA(27)		;I7GUEPL3
ENDIF
		

;---------------------3 parameter logit model implementation---------------------
IF(MODEL.EQ.PL3) THEN
 	P1=GUE+(1-GUE)*EXP(DIS*(PSI-DIF))/(1+EXP(DIS*(PSI-DIF)))
	P0=1-P1
ENDIF
IF(MODEL.EQ.PL3.AND.DV.EQ.0) P=P0
IF(MODEL.EQ.PL3.AND.DV.EQ.1) P=P1
;----------------------Graded response model implementation----------------------

IF(MODEL.EQ.GR) THEN
	DIFG1=DIF1 
	DIFG2=DIFG1+DIF2
	DIFG3=DIFG2+DIF3
	DIFG4=DIFG3+DIF4
	DIFG5=DIFG4+DIF5
	
	PGE1=EXP(DIS*(PSI-DIFG1))/(1+EXP(DIS*(PSI-DIFG1)))
	PGE2=EXP(DIS*(PSI-DIFG2))/(1+EXP(DIS*(PSI-DIFG2)))
	PGE3=EXP(DIS*(PSI-DIFG3))/(1+EXP(DIS*(PSI-DIFG3)))
	PGE4=EXP(DIS*(PSI-DIFG4))/(1+EXP(DIS*(PSI-DIFG4)))
	PGE5=EXP(DIS*(PSI-DIFG5))/(1+EXP(DIS*(PSI-DIFG5)))

	P0=1-PGE1
	P1=PGE1-PGE2
	P2=PGE2-PGE3
	P3=PGE3-PGE4
	P4=PGE4-PGE5
	P5=PGE5
ENDIF

IF(MODEL.EQ.GR.AND.DV.EQ.0) P=P0
IF(MODEL.EQ.GR.AND.DV.EQ.1) P=P1
IF(MODEL.EQ.GR.AND.DV.EQ.2) P=P2
IF(MODEL.EQ.GR.AND.DV.EQ.3) P=P3
IF(MODEL.EQ.GR.AND.DV.EQ.4) P=P4
IF(MODEL.EQ.GR.AND.DV.EQ.5) P=P5


;------------------------Response probability prediction-------------------------

Y=-2*LOG(P)

;--------------------------------Simulation code---------------------------------

IF(ICALL.EQ.4) THEN
   	IF(MODEL.EQ.PL3) THEN
	   	CALL RANDOM (2,R)
   		SDV=0
		IF(P1.GT.R) SDV=1
	ENDIF		

	IF(MODEL.EQ.GR) THEN
		CALL RANDOM (2,R)
		SDV=0
		IF(R.LT.PGE1) SDV=1
		IF(R.LT.PGE2) SDV=2
		IF(R.LT.PGE3) SDV=3
		IF(R.LT.PGE4) SDV=4
		IF(R.LT.PGE5) SDV=5
	ENDIF

	IF(ITEM.EQ.1) SCORE=0
	IF(ITEM.EQ.100) DV=SCORE
	SCORE=SCORE+SDV
	DV=SDV
ENDIF

$ESTIMATION MAXEVAL=99999 METHOD=COND LAPLACE -2LL PRINT=1
            MSFO=msf_run3
$TABLE      ID ITEM DV PSI MDV FILE=psi_estimates_tab3 NOAPPEND
            ONEHEADER NOPRINT
$TABLE      ID ITEM DIS DIF GUE DIF1 DIF2 DIF3 DIF4 DIF5 MDV
            FILE=item_parameters_tab3 NOAPPEND ONEHEADER NOPRINT
$OMEGA  1  FIX
$THETA  (0,1.188050) ; 1	I1DISGR
$THETA  -3.98983 ; 2	I1DIF1GR
$THETA  (0,1.546650,1000000) ; 3	I1DIF2GR
$THETA  (0,1.470980,1000000) ; 4	I1DIF3GR
$THETA  (0,1.992950,1000000) ; 5	I1DIF4GR
$THETA  (0,1.920180,1000000) ; 6	I1DIF5GR
$THETA  (0,1.978640) ; 7	I2DISGR
$THETA  -3.93708 ; 8	I2DIF1GR
$THETA  (0,2.036210,1000000) ; 9	I2DIF2GR
$THETA  (0,1.961200,1000000) ; 10	I2DIF3GR
$THETA  (0,1.034370,1000000) ; 11	I2DIF4GR
$THETA  (0,1.133410,1000000) ; 12	I2DIF5GR
$THETA  (0,1.987810) ; 13	I3DISPL3
$THETA  (-1000000,1.012210,1000000) ; 14	I3DIFPL3
$THETA  (0,0.01,1) ; 15	I3GUEPL3
$THETA  (0,1.512550) ; 16	I4DISPL3
$THETA  (-1000000,0.564404,1000000) ; 17	I4DIFPL3
$THETA  (0,0.01,1) ; 18	I4GUEPL3
$THETA  (0,0.554845) ; 19	I5DISPL3
$THETA  (-1000000,3.304470,1000000) ; 20	I5DIFPL3
$THETA  (0,0.01,1) ; 21	I5GUEPL3
$THETA  (0,0.551635) ; 22	I6DISPL3
$THETA  (-1000000,-0.25033,1000000) ; 23	I6DIFPL3
$THETA  (0,0.01,1) ; 24	I6GUEPL3
$THETA  (0,1.571860) ; 25	I7DISPL3
$THETA  (-1000000,1.623590,1000000) ; 26	I7DIFPL3
$THETA  (0,0.01,1) ; 27	I7GUEPL3

$PROBLEM   
$INPUT      ID ITEM DV MDV
$DATA       trial_db_data.csv IGNORE=@ REWIND
$SIMULATION (21398012) (32131288 UNI) ONLYSIM NOPRED TRUE=FINAL
$MSFI       msf_run3
$TABLE      ID ITEM DV PSI MDV FILE=mirror_plot_tab3 NOAPPEND
            ONEHEADER NOPRINT

